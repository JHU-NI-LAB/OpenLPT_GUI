name: Sync to Lab Repository

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch: # 允许手动触发
    inputs:
      tag_name:
        description: '要同步的标签名称 (例如 v2.1.0)'
        required: false
        default: ''

jobs:
  repo-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Push to Lab Repo
        env:
          GH_TOKEN: ${{ secrets.LAB_REPO_TOKEN }}
          MY_TOKEN: ${{ secrets.LAB_REPO_TOKEN }}
        run: |
          # 1. 配置远程并同步分支/标签
          git remote add lab https://x-access-token:${MY_TOKEN}@github.com/JHU-NI-LAB/OpenLPT_GUI.git
          git push lab origin/main:main --force
          git push lab --tags --force

          # 2. 如果是标签推送或手动触发，则镜像 Release 及其附件
          TAG_NAME=""
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
          elif [[ "${{ github.event.inputs.tag_name }}" != "" ]]; then
            TAG_NAME="${{ github.event.inputs.tag_name }}"
          fi

          if [[ "$TAG_NAME" != "" ]]; then
            echo "Syncing Release for: $TAG_NAME"
            
            # 检查原仓库是否存在 Release 对象
            if gh release view "$TAG_NAME" --repo "$GITHUB_REPOSITORY" > /dev/null 2>&1; then
              echo "Release found on source repo. Mirroring metadata and assets..."
              # 下载原 Release 附件
              mkdir -p ./release_assets
              gh release download "$TAG_NAME" --dir ./release_assets --repo "$GITHUB_REPOSITORY" --clobber || echo "No assets to download."
              
              # 获取原 Release 信息
              REL_TITLE=$(gh release view "$TAG_NAME" --json name -q .name --repo "$GITHUB_REPOSITORY")
              REL_BODY=$(gh release view "$TAG_NAME" --json body -q .body --repo "$GITHUB_REPOSITORY")
            else
              echo "No Release found on source repo for $TAG_NAME (only tag exists). Using default metadata."
              REL_TITLE="$TAG_NAME"
              REL_BODY="Release for $TAG_NAME"
            fi
            
            # 在目标仓库创建/更新 Release
            # 检查是否有附件需要上传
            if [ "$(ls -A ./release_assets 2>/dev/null)" ]; then
              echo "Uploading assets..."
              gh release create "$TAG_NAME" ./release_assets/* \
                --repo "JHU-NI-LAB/OpenLPT_GUI" \
                --title "$REL_TITLE" \
                --notes "$REL_BODY" \
                --verify-tag || gh release edit "$TAG_NAME" --notes "$REL_BODY" --title "$REL_TITLE" --repo "JHU-NI-LAB/OpenLPT_GUI"
            else
              echo "Creating/updating release metadata only."
              gh release create "$TAG_NAME" \
                --repo "JHU-NI-LAB/OpenLPT_GUI" \
                --title "$REL_TITLE" \
                --notes "$REL_BODY" \
                --verify-tag || gh release edit "$TAG_NAME" --notes "$REL_BODY" --title "$REL_TITLE" --repo "JHU-NI-LAB/OpenLPT_GUI"
            fi
          fi